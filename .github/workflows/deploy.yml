name: Deploy VSP Interior Frontend (Next.js)

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # -----------------------------
      # Setup Node 20
      # -----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # -----------------------------
      # Install & Build (ONLY HERE)
      # -----------------------------
      - name: Install Dependencies
        run: npm ci --legacy-peer-deps

      - name: Build Application
        run: npm run build

      # -----------------------------
      # Set Branch Variables
      # -----------------------------
      - name: Set branch variables
        run: |
          if [ "${GITHUB_REF#refs/heads/}" = "main" ]; then
            echo "PROJECT_DIR=vsp-frontend-prod" >> $GITHUB_ENV
            echo "PORT=3000" >> $GITHUB_ENV
            echo "ENV_CONTENT=${{ secrets.ENV_PROD }}" >> $GITHUB_ENV
          else
            echo "PROJECT_DIR=vsp-frontend-dev" >> $GITHUB_ENV
            echo "PORT=3001" >> $GITHUB_ENV
            echo "ENV_CONTENT=${{ secrets.ENV_DEV }}" >> $GITHUB_ENV
          fi

      # -----------------------------
      # Setup SSH
      # -----------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # -----------------------------
      # Deploy Built Files
      # -----------------------------
      - name: Deploy to EC2
        run: |
          echo "Deploying built application..."

          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            --exclude=.git \
            --exclude=.env* \
            ./ ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/${{ env.PROJECT_DIR }}/

          echo "${{ env.ENV_CONTENT }}" | \
            ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} \
            "cat > /home/ec2-user/${{ env.PROJECT_DIR }}/.env"

      # -----------------------------
      # Restart App (NO BUILD HERE)
      # -----------------------------
      - name: Restart App on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << EOF
            set -e
            cd /home/ec2-user/${{ env.PROJECT_DIR }}

            # Stop old process if running
            if lsof -Pi :${{ env.PORT }} -sTCP:LISTEN -t >/dev/null 2>&1; then
              echo "Stopping existing process..."
              lsof -ti:${{ env.PORT }} | xargs kill -15 || true
              sleep 3
            fi

            echo "Starting application on port ${{ env.PORT }}..."
            PORT=${{ env.PORT }} nohup npm run start > app.log 2>&1 &

            sleep 5

            if lsof -Pi :${{ env.PORT }} -sTCP:LISTEN -t >/dev/null 2>&1; then
              echo "Deployment successful!"
            else
              echo "Deployment failed!"
              cat app.log
              exit 1
            fi
          EOF

