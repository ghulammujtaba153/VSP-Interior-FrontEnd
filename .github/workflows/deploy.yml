name: Deploy VSP Interior Frontend (Next.js)

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout the repo
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # -----------------------------
      # Setup Node 20
      # -----------------------------
      - name: Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # -----------------------------
      # Install dependencies and build
      # -----------------------------
      - name: Install Dependencies & Build
        run: |
          npm ci --legacy-peer-deps
          npm run build

      # -----------------------------
      # Determine branch-specific variables
      # -----------------------------
      - name: Set branch variables
        id: branch_vars
        run: |
          if [ "${GITHUB_REF#refs/heads/}" = "main" ]; then
            echo "PROJECT_DIR=vsp-frontend-prod" >> $GITHUB_ENV
            echo "PORT=3000" >> $GITHUB_ENV
            echo "ENV_CONTENT=${{ secrets.ENV_PROD }}" >> $GITHUB_ENV
          elif [ "${GITHUB_REF#refs/heads/}" = "dev" ]; then
            echo "PROJECT_DIR=vsp-frontend-dev" >> $GITHUB_ENV
            echo "PORT=3001" >> $GITHUB_ENV
            echo "ENV_CONTENT=${{ secrets.ENV_DEV }}" >> $GITHUB_ENV
          else
            echo "Branch not configured for deployment"
            exit 1
          fi

      # -----------------------------
      # Set up SSH agent for EC2
      # -----------------------------
      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # -----------------------------
      # Deploy source and build to EC2
      # -----------------------------
      - name: Deploy to EC2
        run: |
          echo "Deploying application to EC2..."
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" \
            --exclude=node_modules --exclude=.git --exclude=.env* \
            ./ ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/${{ env.PROJECT_DIR }}/
          
          echo "Creating .env file from secrets..."
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} \
            "cat > /home/ec2-user/${{ env.PROJECT_DIR }}/.env << 'ENVEOF'
${{ env.ENV_CONTENT }}
ENVEOF"

      # -----------------------------
      # Start the app on EC2
      # -----------------------------
      - name: Start App on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} <<- 'EOF'
            set -e
            cd /home/ec2-user/${PROJECT_DIR}

            # Install dependencies
            npm ci --legacy-peer-deps

            # Build the application
            npm run build

            # Stop existing process if running
            if lsof -Pi :${PORT} -sTCP:LISTEN -t >/dev/null 2>&1; then
              echo "Stopping existing process on port ${PORT}..."
              lsof -ti:${PORT} | xargs kill -15 || true
              sleep 3
            fi
            echo "Starting Next.js application on port ${PORT}..."
            PORT=${PORT} nohup npm run start > /tmp/${PROJECT_DIR}.log 2>&1 &

            sleep 5

            # Verify deployment
            if lsof -Pi :${PORT} -sTCP:LISTEN -t >/dev/null 2>&1 ; then
              echo "✓ Deployment successful!"
              echo "Application is running on port ${PORT}"
            else
              echo "✗ Deployment failed!"
              cat /tmp/${PROJECT_DIR}.log
              exit 1
            fi
            EOF

