name: Deploy VSP Interior Frontend (Next.js)

on:
  push:
    branches:
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout the repo
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v3

      # -----------------------------
      # Setup Node 20
      # -----------------------------
      - name: Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # -----------------------------
      # Install dependencies and build
      # -----------------------------
      - name: Install Dependencies & Build
        run: |
          npm ci --legacy-peer-deps
          npm run build

      # -----------------------------
      # Determine branch-specific variables
      # -----------------------------
      - name: Set branch variables
        id: branch_vars
        run: |
          if [ "${GITHUB_REF#refs/heads/}" = "main" ]; then
            echo "PROJECT_DIR=vsp-frontend-prod" >> $GITHUB_ENV
            echo "PORT=3000" >> $GITHUB_ENV
            echo "ENV_FILE=.env.prod" >> $GITHUB_ENV
          elif [ "${GITHUB_REF#refs/heads/}" = "dev" ]; then
            echo "PROJECT_DIR=vsp-frontend-dev" >> $GITHUB_ENV
            echo "PORT=3001" >> $GITHUB_ENV
            echo "ENV_FILE=.env.dev" >> $GITHUB_ENV
          else
            echo "Branch not configured for deployment"
            exit 1
          fi

      # -----------------------------
      # Set up SSH agent for EC2
      # -----------------------------
      - name: Set up SSH Agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # -----------------------------
      # Deploy built files to EC2
      # -----------------------------
      - name: Deploy to EC2
        run: |
          echo "Deploying built files to EC2..."
          rsync -avz -e "ssh -o StrictHostKeyChecking=no" \
            .next package.json package-lock.json node_modules ${{ env.ENV_FILE }} \
            ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/${{ env.PROJECT_DIR }}/

      # -----------------------------
      # Start the app on EC2
      # -----------------------------
      - name: Start App on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << EOF
            set -e
            cd /home/ec2-user/${{ env.PROJECT_DIR }}

            # Copy env file
            cp ${{ env.ENV_FILE }} .env

            # Stop existing process if running
            if lsof -Pi :${{ env.PORT }} -sTCP:LISTEN -t >/dev/null 2>&1; then
              echo "Stopping existing process on port ${{ env.PORT }}..."
              lsof -ti:${{ env.PORT }} | xargs kill -15 || true
              sleep 3
            fi

            # Start Next.js app with nohup
            echo "Starting Next.js application on port ${{ env.PORT }}..."
            PORT=${{ env.PORT }} nohup npm run start > /tmp/${{ env.PROJECT_DIR }}.log 2>&1 &

            sleep 5

            # Verify deployment
            if lsof -Pi :${{ env.PORT }} -sTCP:LISTEN -t >/dev/null 2>&1 ; then
              echo "✓ Deployment successful!"
              echo "Application is running on port ${{ env.PORT }}"
            else
              echo "✗ Deployment failed!"
              cat /tmp/${{ env.PROJECT_DIR }}.log
              exit 1
            fi
EOF
