- name: Deploy and Run on EC2
  run: |
    ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << EOF
      set -e

      # Determine project directory and port
      if [ "${GITHUB_REF#refs/heads/}" = "main" ]; then
        PROJECT_DIR=~/vsp-frontend-prod
        APP_PORT=3000
      else
        PROJECT_DIR=~/vsp-frontend-dev
        APP_PORT=3001
      fi

      echo "Preparing $PROJECT_DIR on EC2..."
      mkdir -p \$PROJECT_DIR
      rm -rf \$PROJECT_DIR/*

      echo "Deploying files..."
      exit
    EOF

- name: Rsync built files
  run: |
    rsync -avz --delete \
      -e "ssh -o StrictHostKeyChecking=no" \
      --exclude=.git \
      --exclude=.env* \
      ./ ec2-user@${{ secrets.EC2_HOST }}:/home/ec2-user/${{ env.PROJECT_DIR }}/

- name: Update .env on EC2
  run: |
    echo "${{ env.ENV_CONTENT }}" | ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} \
      "cat > /home/ec2-user/${{ env.PROJECT_DIR }}/.env"

- name: Restart Next.js app
  run: |
    ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_HOST }} << EOF
      set -e
      cd /home/ec2-user/${{ env.PROJECT_DIR }}

      # Kill old process
      if lsof -Pi :\$APP_PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo "Stopping existing process on port \$APP_PORT..."
        lsof -ti :\$APP_PORT | xargs kill -9 || true
        sleep 2
      fi

      echo "Starting Next.js on port \$APP_PORT..."
      export PORT=\$APP_PORT
      nohup npm run start -- -H 0.0.0.0 > app.log 2>&1 &

      sleep 5
      if lsof -Pi :\$APP_PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo "Deployment successful! App running on \$APP_PORT"
      else
        echo "Deployment failed!"
        cat app.log
        exit 1
      fi
    EOF
